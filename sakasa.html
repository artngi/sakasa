<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逆さ言葉当てゲーム</title>
    <style>
        body {
            font-family: "sans-serif";
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #game-container {
            width: 380px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        .top-btns {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .score-label { font-size: 1.2em; margin-bottom: 5px; }
        .main-label { font-size: 1.1em; margin-bottom: 15px; min-height: 2.4em; color: #333; }
        .word-display {
            font-family: "monospace";
            font-size: 24px;
            font-weight: bold;
            color: blue;
            margin: 20px 0;
            letter-spacing: 5px;
        }
        .input-display {
            font-size: 1.5em;
            background: white;
            border: 2px solid #ccc;
            height: 40px;
            line-height: 40px;
            margin-bottom: 15px;
            border-radius: 5px;
            min-height: 1.5em;
        }
        .control-btns {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-roulette { background-color: #ADD8E6; font-weight: bold; }
        .btn-submit { background-color: #90EE90; font-weight: bold; }
        .btn-mode { background-color: #ffd700; font-weight: bold; flex: 2; }
        .btn-help { background-color: #ffb6c1; font-weight: bold; flex: 1; }
        button:disabled { background-color: #eee; cursor: not-allowed; color: #aaa; }

        /* 説明画面（モーダル）のスタイル */
        #how-to-play-overlay {
            display: none; /* 最初は隠しておく */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            color: white;
            z-index: 10;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            padding: 20px;
            text-align: left;
        }
        .modal-content h2 { border-bottom: 2px solid white; padding-bottom: 5px; text-align: center; }
        .btn-close {
            display: block;
            margin: 20px auto 0;
            background: white;
            color: black;
            font-weight: bold;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        .kb-btn { padding: 8px 0; font-size: 16px; background: #fff; }
        .kb-btn-wide { grid-column: span 2; }
        .empty-slot { visibility: hidden; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="top-btns">
        <button id="btn-mode-toggle" class="btn-mode" onclick="toggleMode()">モード: ひらがな</button>
        <button class="btn-help" onclick="showHelp()">遊び方</button>
    </div>

    <div id="how-to-play-overlay">
        <div class="modal-content">
            <h2>あそびかた</h2>
            <div id="help-text">
                1. ルーレットをまわすと、もじが決まるよ！<br>
                2. そのもじが、さかさまで、かくされて出てくるよ！<br>
                3. 「ヒント」をおすと、もじをかくしているものがひとつきえるよ！<br>
                4. キーボードで、もとの言葉をうちこもう！<br>
                5. 「回答」をおして当たればポイントゲット！かくれているもじのかず、ポイントがもらえるよ！
            </div>
            <button class="btn-close" onclick="hideHelp()">とじる</button>
        </div>
    </div>

    <div class="score-label" id="score-label">スコア: 0</div>
    <div class="main-label" id="main-label">ルーレットを回してね！</div>
    <div class="word-display" id="word-display">&nbsp;</div>
    <div class="input-display" id="input-display"></div>

    <div class="control-btns">
        <button class="btn-roulette" id="btn-roulette" onclick="startRoulette()">ルーレット</button>
        <button id="btn-reveal" onclick="revealChar()" disabled>ヒント</button>
        <button class="btn-submit" onclick="checkAnswer()">回答</button>
    </div>

    <div class="keyboard" id="keyboard"></div>
</div>

<script>
// --- モード別・語彙データ ---
const WORDS = {
    hiragana: {
        3: ["すいか", "きつね", "さくら", "くるま", "めだか", "いちご", "つくえ", "たぬき", "おむすび", "ひみつ", "すずめ", "からす", "うちわ"],
        4: ["ひまわり", "らいおん", "おにぎり", "あさがお", "せんせい", "えんぴつ", "ともだち", "しんぶん", "ふうせん", "てんとうむし", "にじゅう", "どうぶつ"],
        5: ["こいのぼり", "おべんとう", "ようちえん", "しゃぼんだま", "かたつむり", "おとしだま", "なつやすみ", "ほしぞら", "じどうしゃ", "すいぞくかん"],
        6: ["どらえもん", "ゆうえんち", "おしょうがつ", "とうもろこし", "きょうしつ", "せんたくき", "しょくどう", "たんじょうび", "どうぶつえん"],
        7: ["ぷろぐらみんぐ", "なつまつり", "おもちゃばこ", "ひこうきぐも", "としょかん", "てれびげーむ", "じどうはんばいき", "こうつうあんぜん"]
    },
    katakana: {
        3: ["アイス", "ピアノ", "バナナ", "コアラ", "マスク", "カメラ", "コップ", "パンダ", "ヨット", "メダル", "ラッパ", "ドア", "ノート"],
        4: ["ライオン", "テレビ", "ノート", "トイレ", "ケーキ", "ギター", "クレヨン", "ロボット", "マスク", "メロン", "レモン", "パトカー"],
        5: ["チョコレート", "パトカー", "ハンバーグ", "ランドセル", "サッカー", "デザート", "ピクニック", "マフラー", "カレンダー", "マラソン"],
        6: ["スマートフォン", "アイスクリーム", "プログラミング", "ヘリコプター", "パトロール", "バイオリン", "レストラン", "ペンギン"],
        7: ["スーパーマーケット", "オートバイ", "ハンバーガー", "サンドイッチ", "クリスマス", "オムライス", "バドミントン", "ボランティア"]
    }
};

let score = 0;
let currentWord = "";
let reversedWord = "";
let displayChars = 0;
let inputText = "";
let currentLanguage = "hiragana";

// --- 説明表示の関数 ---
function showHelp() {
    document.getElementById('how-to-play-overlay').style.display = 'flex';
}
function hideHelp() {
    document.getElementById('how-to-play-overlay').style.display = 'none';
}

function toggleMode() {
    currentLanguage = (currentLanguage === "hiragana") ? "katakana" : "hiragana";
    document.getElementById('btn-mode-toggle').innerText = `モード: ${currentLanguage === "hiragana" ? "ひらがな" : "カタカナ"}`;
    createKeyboard();
    resetRound();
}

function createKeyboard() {
    const kbContainer = document.getElementById('keyboard');
    kbContainer.innerHTML = "";
    const hiraChars = [
        ["あ","い","う","え","お"], ["か","き","く","け","こ"],
        ["さ","し","す","せ","そ"], ["た","ち","つ","て","と"],
        ["な","に","ぬ","ね","の"], ["は","ひ","ふ","へ","ほ"],
        ["ま","み","む","め","も"], ["や","ゆ","よ"," "," "],
        ["ら","り","る","れ","ろ"], ["わ","を","ん"," "," "],
        ["ー","っ","小","゛゜","消去"]
    ];
    const toKata = (str) => str.replace(/[ぁ-ん]/g, s => String.fromCharCode(s.charCodeAt(0) + 0x60));

    hiraChars.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            if (char === " ") {
                btn.className = "empty-slot";
            } else {
                let displayChar = char;
                if (currentLanguage === "katakana" && char.match(/[ぁ-ん]/)) {
                    displayChar = toKata(char);
                }
                btn.innerText = displayChar;
                btn.className = "kb-btn";
                if (char === "消去") btn.classList.add("kb-btn-wide");
                btn.onclick = () => kbClick(displayChar);
            }
            kbContainer.appendChild(btn);
        });
    });
}

function kbClick(char) {
    if (char === "消去") {
        inputText = inputText.slice(0, -1);
    } else if (char === "゛゜") {
        applyDakuten();
    } else if (char === "小") {
        applySmall();
    } else {
        inputText += char;
    }
    document.getElementById('input-display').innerText = inputText;
}

function applyDakuten() {
    // 変換サイクルの定義
    const cycle = {
        // ひらがな
        "は":"ば", "ば":"ぱ", "ぱ":"は",
        "ひ":"び", "び":"ぴ", "ぴ":"ひ",
        "ふ":"ぶ", "ぶ":"ぷ", "ぷ":"ふ",
        "へ":"べ", "べ":"ぺ", "ぺ":"へ",
        "ほ":"ぼ", "ぼ":"ぽ", "ぽ":"ほ",
        // カタカナ
        "ハ":"バ", "バ":"パ", "パ":"ハ",
        "ヒ":"ビ", "ビ":"ピ", "ピ":"ヒ",
        "フ":"ブ", "ブ":"プ", "プ":"フ",
        "ヘ":"ベ", "ベ":"ペ", "ペ":"ヘ",
        "ホ":"ボ", "ボ":"ポ", "ポ":"ホ",
        
        // 通常の濁点（2段階サイクル）
        "か":"が", "が":"か", "き":"ぎ", "ぎ":"き", "く":"ぐ", "ぐ":"く", "け":"げ", "げ":"け", "こ":"ご", "ご":"こ",
        "さ":"ざ", "ざ":"さ", "し":"じ", "じ":"し", "す":"ず", "ず":"す", "せ":"ぜ", "ぜ":"せ", "そ":"ぞ", "ぞ":"そ",
        "た":"だ", "だ":"た", "ち":"ぢ", "ぢ":"ち", "つ":"づ", "づ":"つ", "て":"で", "で":"て", "と":"ど", "ど":"と",
        "カ":"ガ", "ガ":"カ", "キ":"ギ", "ギ":"キ", "ク":"グ", "グ":"ク", "ケ":"ゲ", "ゲ":"ケ", "コ":"ゴ", "ゴ":"コ",
        "サ":"ザ", "ザ":"サ", "シ":"ジ", "ジ":"シ", "ス":"ズ", "ズ":"ス", "セ":"ゼ", "ゼ":"セ", "ソ":"ゾ", "ゾ":"そ",
        "タ":"ダ", "ダ":"タ", "チ":"ヂ", "ヂ":"チ", "ツ":"ヅ", "ヅ":"ツ", "テ":"デ", "デ":"テ", "ト":"ド", "ど":"ト"
    };

    let last = inputText.slice(-1); // 入力された最後の1文字を取得
    if (cycle[last]) {
        // サイクル表に文字があれば、次の文字に置き換える
        inputText = inputText.slice(0, -1) + cycle[last];
    }
    document.getElementById('input-display').innerText = inputText;
}

function applySmall() {
    const map = {
        "あ":"ぁ","い":"ぃ","う":"ぅ","え":"ぇ","お":"ぉ","や":"ゃ","ゆ":"ゅ","よ":"ょ","つ":"っ",
        "ア":"ァ","イ":"ィ","ウ":"ゥ","エ":"ェ","オ":"ォ","ヤ":"ャ","ユ":"ュ","ョ":"ヨ","ツ":"ッ",
        "ぁ":"あ","ぃ":"い","ぅ":"う","ぇ":"え","ぉ":"お","ゃ":"や","ゅ":"ゆ","ょ":"よ","っ":"つ",
        "ァ":"ア","ィ":"イ","ゥ":"ウ","ェ":"エ","ォ":"オ","ャ":"ヤ","ュ":"ユ","ョ":"ヨ","ッ":"ツ"
    };
    let last = inputText.slice(-1);
    if (map[last]) inputText = inputText.slice(0, -1) + map[last];
    document.getElementById('input-display').innerText = inputText;
}

async function startRoulette() {
    inputText = "";
    document.getElementById('input-display').innerText = "";
    document.getElementById('btn-roulette').disabled = true;
    document.getElementById('btn-mode-toggle').disabled = true;
    
    for (let i = 0; i < 8; i++) {
        let l = Math.floor(Math.random() * 5) + 3;
        document.getElementById('main-label').innerText = `抽選中... ${l}文字`;
        await new Promise(r => setTimeout(r, 80));
    }
    
    const length = Math.floor(Math.random() * 5) + 3;
    const wordList = WORDS[currentLanguage][length];
    currentWord = wordList[Math.floor(Math.random() * wordList.length)];
    reversedWord = currentWord.split('').reverse().join('');
    displayChars = 0;
    
    document.getElementById('main-label').innerText = `【 ${currentWord.length}文字 】を当ててね！`;
    updateWordDisplay();
    document.getElementById('btn-reveal').disabled = false;
}

function updateWordDisplay() {
    let display = "";
    for (let i = 0; i < reversedWord.length; i++) {
        display += (i < displayChars) ? reversedWord[i] : "□";
    }
    document.getElementById('word-display').innerText = display;
}

function revealChar() {
    if (displayChars < reversedWord.length) {
        displayChars++;
        updateWordDisplay();
    }
    if (displayChars >= reversedWord.length) document.getElementById('btn-reveal').disabled = true;
}

function checkAnswer() {
    if (inputText === currentWord) {
        let points = Math.max(reversedWord.length - displayChars, 0);
        score += points;
        alert(`正解！\n答えは「${currentWord}」でした！\n${points}点ゲット！`);
        resetRound();
    } else if (inputText !== "") {
        alert("残念！ちがうよ！");
    }
}

function resetRound() {
    document.getElementById('score-label').innerText = `スコア: ${score}`;
    inputText = "";
    document.getElementById('input-display').innerText = "";
    document.getElementById('btn-roulette').disabled = false;
    document.getElementById('btn-mode-toggle').disabled = false;
    document.getElementById('btn-reveal').disabled = true;
    document.getElementById('word-display').innerHTML = "&nbsp;";
    document.getElementById('main-label').innerText = "ルーレットをまわしてね！";
}

createKeyboard();
</script>

</body>
</html>